require('dotenv').config();
const { Telegraf } = require('telegraf');
const unifiedMessageHandler = require('./handlers/unifiedMessageHandler');
const bankService = require('./services/bankService');
const expenseService = require('./services/expenseService');
const financeService = require('./services/financeService');
const incomeAnalysisService = require('./services/incomeAnalysisService');
const { handleJarCallbacks } = require('./handlers/callbackHandler');
const jarService = require('./services/jarService');


const bot = new Telegraf(process.env.BOT_TOKEN);

// Error handling
bot.catch((err, ctx) => {
  console.error('âŒ Bot error:', err);
  if (ctx) {
    ctx.reply('âŒ ÄÃ£ xáº£y ra lá»—i, vui lÃ²ng thá»­ láº¡i!');
  }
});

// Import finance handler
const { handleFinanceCommands } = require('./handlers/financeHandler');

// Message handlers - Unified handler for smart processing
bot.on('text', unifiedMessageHandler);

// Start command with main menu
bot.start((ctx) => {
  const mainMenuKeyboard = {
    inline_keyboard: [
      [
        { text: 'ğŸ“Š Thá»‘ng kÃª', callback_data: 'stats_menu' },
        { text: 'ğŸ“‹ Lá»‹ch sá»­', callback_data: 'history' }
      ],
      [
        { text: 'ğŸ’° Thu nháº­p', callback_data: 'income_stats' },
        { text: 'ğŸ’³ Sá»‘ dÆ°', callback_data: 'balance' }
      ],
      [
        { text: 'ğŸº HÅ© tiá»n', callback_data: 'jars' },
        { text: 'ğŸ¯ Má»¥c tiÃªu', callback_data: 'goals' }
      ],
      [
        { text: 'ğŸŒ NgÃ´n ngá»¯', callback_data: 'language_menu' },
        { text: 'â“ HÆ°á»›ng dáº«n', callback_data: 'help' }
      ]
    ]
  };

  ctx.reply(`ğŸ‰ **Bot Quáº£n lÃ½ TÃ i chÃ­nh**

ğŸ’¡ **CÃ¡ch sá»­ dá»¥ng:**
â€¢ Nháº­p: \`"Cafe 30k"\` Ä‘á»ƒ ghi chi tiÃªu
â€¢ Nháº­p: \`"LÆ°Æ¡ng thÃ¡ng 7 15000000"\` Ä‘á»ƒ ghi thu nháº­p
â€¢ Nháº­p: \`"thá»‘ng kÃª 15/12/2024"\` Ä‘á»ƒ xem thá»‘ng kÃª

ğŸ¤– **AI tá»± Ä‘á»™ng phÃ¢n loáº¡i thu nháº­p:**
â€¢ LÆ°Æ¡ng, ThÆ°á»Ÿng, Freelance, Äáº§u tÆ°, Cho thuÃª
â€¢ PhÃ¢n tÃ­ch hiá»‡u suáº¥t vÃ  Ä‘Æ°a ra gá»£i Ã½
â€¢ Theo dÃµi má»¥c tiÃªu thu nháº­p

ğŸ‘‡ **Chá»n chá»©c nÄƒng:**`, 
    { 
      reply_markup: mainMenuKeyboard,
      parse_mode: 'Markdown'
    }
  );
});

// Handle callback queries from inline keyboard
bot.on('callback_query', async (ctx) => {
  const callbackData = ctx.callbackQuery.data;
  const userId = String(ctx.from.id);
  
  // Answer callback query to remove loading state
  await ctx.answerCbQuery();
  
  try {
    // Xá»­ lÃ½ callback hÅ© tiá»n trÆ°á»›c
    const jarCallbackHandled = await handleJarCallbacks(ctx);
    if (jarCallbackHandled) {
      return; // ÄÃ£ xá»­ lÃ½ callback hÅ© tiá»n
    }
    

    
    switch (callbackData) {
      case 'stats_menu':
        await ctx.editMessageText(`ğŸ“Š **Thá»‘ng kÃª Chi tiÃªu**

ğŸ“… **Chá»n thá»i gian:**`, 
          {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ“… HÃ´m nay', callback_data: 'stats_today' },
                  { text: 'ğŸ“… Tuáº§n nÃ y', callback_data: 'stats_week' }
                ],
                [
                  { text: 'ğŸ“… ThÃ¡ng nÃ y', callback_data: 'stats_month' },
                  { text: 'ğŸ“… NÄƒm nÃ y', callback_data: 'stats_year' }
                ],
                [
                  { text: 'ğŸ¯ TÃ¹y chá»‰nh', callback_data: 'stats_custom' },
                  { text: 'ğŸ”™ Menu chÃ­nh', callback_data: 'main_menu' }
                ]
              ]
            },
            parse_mode: 'Markdown'
          }
        );
        break;
        
      case 'stats_today':
      case 'stats_week':
      case 'stats_month':
      case 'stats_year':
        const period = callbackData.replace('stats_', '');
        const stats = await financeService.getExpenseStats(userId, period);
        
        let message = `ğŸ“Š **Thá»‘ng kÃª ${getPeriodText(period)}**\n`;
        message += `ğŸ“… **${getCurrentDateText(period)}**\n\n`;
        message += `ğŸ’° **Tá»•ng:** ${stats.totalAmount.toLocaleString('vi-VN')}Ä‘\n`;
        message += `ğŸ“ **Giao dá»‹ch:** ${stats.totalTransactions}\n\n`;
        
        if (stats.categories && stats.categories.length > 0) {
          message += `ğŸ“‚ **Danh má»¥c:**\n`;
          stats.categories.forEach(cat => {
            const percentage = ((cat.amount / stats.totalAmount) * 100).toFixed(1);
            message += `â€¢ ${cat.category}: ${cat.amount.toLocaleString('vi-VN')}Ä‘ (${percentage}%)\n`;
          });
        }
        
        // Táº¡o buttons cho tá»«ng danh má»¥c
        const categoryButtons = [];
        if (stats.categories && stats.categories.length > 0) {
          const categoryRow = [];
          stats.categories.slice(0, 3).forEach(cat => {
            categoryRow.push({ 
              text: `ğŸ“‚ ${cat.category}`, 
              callback_data: `stats_category_${period}_${cat.category}` 
            });
          });
          categoryButtons.push(categoryRow);
        }
        
        await ctx.editMessageText(message, {
          reply_markup: {
            inline_keyboard: [
              ...categoryButtons,
              [
                { text: 'ğŸ“… TÃ¹y chá»‰nh', callback_data: 'stats_custom' },
                { text: 'ğŸ”™ Thá»‘ng kÃª', callback_data: 'stats_menu' }
              ],
              [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
            ]
          },
          parse_mode: 'Markdown'
        });
        break;
        
      case (callbackData.match(/^stats_category_/) ? callbackData : null):
        const categoryMatch = callbackData.match(/^stats_category_(.+)_(.+)$/);
        if (categoryMatch) {
          const [, period, category] = categoryMatch;
          const categoryStats = await financeService.getExpenseStatsByCategory(userId, period, category);
          
          let categoryMessage = `ğŸ“‚ **Thá»‘ng kÃª ${category}**\n`;
          categoryMessage += `ğŸ“… **${getCurrentDateText(period)}**\n\n`;
          categoryMessage += `ğŸ’° **Tá»•ng:** ${categoryStats.totalAmount.toLocaleString('vi-VN')}Ä‘\n`;
          categoryMessage += `ğŸ“ **Giao dá»‹ch:** ${categoryStats.totalTransactions}\n\n`;
          
          if (categoryStats.transactions && categoryStats.transactions.length > 0) {
            categoryMessage += `ğŸ“‹ **Chi tiáº¿t giao dá»‹ch:**\n`;
            categoryStats.transactions.slice(0, 5).forEach((transaction, index) => {
              const date = new Date(transaction.date).toLocaleDateString('vi-VN');
              categoryMessage += `${index + 1}. ${transaction.amount.toLocaleString('vi-VN')}Ä‘\n`;
              categoryMessage += `   ğŸ“… ${date}\n`;
              if (transaction.description) {
                categoryMessage += `   ğŸ“ ${transaction.description}\n`;
              }
              categoryMessage += `\n`;
            });
          }
          
          await ctx.editMessageText(categoryMessage, {
            reply_markup: {
              inline_keyboard: [
                [{ text: `ğŸ”™ Thá»‘ng kÃª ${getPeriodText(period)}`, callback_data: `stats_${period}` }],
                [{ text: 'ğŸ”™ Thá»‘ng kÃª', callback_data: 'stats_menu' }],
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            },
            parse_mode: 'Markdown'
          });
        }
        break;
        
      case (callbackData.match(/^stats_category_custom_/) ? callbackData : null):
        const customCategoryMatch = callbackData.match(/^stats_category_custom_(.+)$/);
        if (customCategoryMatch) {
          const [, category] = customCategoryMatch;
          // Láº¥y thá»‘ng kÃª tá»« unifiedMessageHandler Ä‘Ã£ xá»­ lÃ½
          const customStats = await financeService.getExpenseStatsByCategory(userId, 'custom', category);
          
          let categoryMessage = `ğŸ“‚ **Thá»‘ng kÃª ${category}**\n`;
          categoryMessage += `ğŸ“… **Thá»i gian tÃ¹y chá»‰nh**\n\n`;
          categoryMessage += `ğŸ’° **Tá»•ng:** ${customStats.totalAmount.toLocaleString('vi-VN')}Ä‘\n`;
          categoryMessage += `ğŸ“ **Giao dá»‹ch:** ${customStats.totalTransactions}\n\n`;
          
          if (customStats.transactions && customStats.transactions.length > 0) {
            categoryMessage += `ğŸ“‹ **Chi tiáº¿t giao dá»‹ch:**\n`;
            customStats.transactions.slice(0, 5).forEach((transaction, index) => {
              const date = new Date(transaction.createdAt).toLocaleDateString('vi-VN');
              categoryMessage += `${index + 1}. ${transaction.amount.toLocaleString('vi-VN')}Ä‘\n`;
              categoryMessage += `   ğŸ“… ${date}\n`;
              if (transaction.note) {
                categoryMessage += `   ğŸ“ ${transaction.note}\n`;
              }
              categoryMessage += `\n`;
            });
          }
          
          await ctx.editMessageText(categoryMessage, {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ”™ Thá»‘ng kÃª tÃ¹y chá»‰nh', callback_data: 'stats_custom' }],
                [{ text: 'ğŸ”™ Thá»‘ng kÃª', callback_data: 'stats_menu' }],
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            },
            parse_mode: 'Markdown'
          });
        }
        break;
        
      case 'stats_custom':
        await ctx.editMessageText(`ğŸ¯ **Thá»‘ng kÃª TÃ¹y chá»‰nh**

ğŸ’¡ **Gá»­i tin nháº¯n:**
â€¢ \`thá»‘ng kÃª 15/12/2024\` (ngÃ y)
â€¢ \`thá»‘ng kÃª 12/2024\` (thÃ¡ng)
â€¢ \`thá»‘ng kÃª 2024\` (nÄƒm)
â€¢ \`thá»‘ng kÃª tá»« 01/12/2024 Ä‘áº¿n 31/12/2024\` (khoáº£ng)

ğŸ“± **Gá»­i tin nháº¯n ngay!**`, {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸ”™ Thá»‘ng kÃª', callback_data: 'stats_menu' }],
              [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
            ]
          },
          parse_mode: 'Markdown'
        });
        break;
        
      case 'main_menu':
        await ctx.editMessageText(`ğŸ‘‹ ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i Bot Quáº£n lÃ½ Chi tiÃªu ThÃ´ng minh!

ğŸ¤– TÃ´i cÃ³ thá»ƒ giÃºp báº¡n:
â€¢ ğŸ“ Ghi chi tiÃªu: "Ä‚n sÃ¡ng 50k"  
â€¢ ğŸ“Š Thá»‘ng kÃª chi tiáº¿t theo thá»i gian
â€¢ ğŸ’° Quáº£n lÃ½ thu nháº­p vÃ  hÅ© tiá»n
â€¢ ğŸ’¬ TÆ° váº¥n tÃ i chÃ­nh thÃ´ng minh
â€¢ ğŸ›ï¸ TÆ° váº¥n mua hÃ ng dá»±a trÃªn dá»¯ liá»‡u
â€¢ ğŸ¦ TÃ­ch há»£p ngÃ¢n hÃ ng tá»± Ä‘á»™ng
â€¢ ğŸ“‹ Theo dÃµi lá»‹ch sá»­ giao dá»‹ch

ğŸ‘‡ Chá»n chá»©c nÄƒng báº¡n muá»‘n sá»­ dá»¥ng:`, 
          { 
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ“Š Xem tá»•ng thu chi', callback_data: 'stats_menu' },
                  { text: 'ğŸ’° Xem tá»•ng thu nháº­p', callback_data: 'income_stats' }
                ],
                [
                  { text: 'ğŸ’³ Sá»‘ tiá»n hiá»‡n táº¡i', callback_data: 'balance' },
                  { text: 'ğŸº Chi tiáº¿t cÃ¡c hÅ©', callback_data: 'jars' }
                ],
                [
                  { text: 'ğŸ“‹ Lá»‹ch sá»­ thu/chi', callback_data: 'history' },
                  { text: 'ğŸ’¬ Chat tÆ° váº¥n', callback_data: 'advisor_main' }
                ],
                [
                  { text: 'ğŸ“± Open App', callback_data: 'open_app' },
                  { text: 'ğŸ¦ Connect Email/Bank', callback_data: 'bank_setup' }
                ],
                [
                  { text: 'ğŸŒ NgÃ´n ngá»¯', callback_data: 'language_menu' },
                  { text: 'â“ HÆ°á»›ng dáº«n', callback_data: 'help' }
                ]
              ]
            },
            parse_mode: 'Markdown'
          }
        );
        break;
        
      // AI Confirmation handlers
      case (callbackData.match(/^confirm_income_/) ? callbackData : null):
        try {
          const amount = parseInt(callbackData.replace('confirm_income_', ''));
          const result = await incomeAnalysisService.processIncomeInput(userId, `Thu nháº­p ${amount}`);
          
          await ctx.editMessageText(`âœ… **ÄÃ£ xÃ¡c nháº­n thu nháº­p!**

${result.message}

ğŸ¤– **AI Ä‘Ã£ tá»± Ä‘á»™ng phÃ¢n loáº¡i vÃ  lÆ°u giao dá»‹ch.**`, {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ“Š PhÃ¢n tÃ­ch thu nháº­p', callback_data: 'income_analysis' },
                  { text: 'ğŸ“‹ Lá»‹ch sá»­ thu nháº­p', callback_data: 'income_history' }
                ],
                [
                  { text: 'ğŸ¯ Má»¥c tiÃªu thu nháº­p', callback_data: 'income_goals' },
                  { text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }
                ]
              ]
            },
            parse_mode: 'Markdown'
          });
        } catch (error) {
          console.error('Error confirming income:', error);
          await ctx.editMessageText('âŒ Lá»—i khi xÃ¡c nháº­n thu nháº­p. Vui lÃ²ng thá»­ láº¡i!', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            }
          });
        }
        break;
        
      case (callbackData.match(/^confirm_expense_/) ? callbackData : null):
        try {
          const amount = parseInt(callbackData.replace('confirm_expense_', ''));
          await expenseService.addExpense(userId, {
            amount: amount,
            category: 'KhÃ¡c',
            note: 'XÃ¡c nháº­n tá»« AI'
          });
          
          await ctx.editMessageText(`âœ… **ÄÃ£ xÃ¡c nháº­n chi tiÃªu!**

ğŸ’¸ **Sá»‘ tiá»n:** ${amount.toLocaleString('vi-VN')}Ä‘
ğŸ“‚ **Danh má»¥c:** KhÃ¡c
ğŸ“… **Thá»i gian:** ${new Date().toLocaleString('vi-VN')}

ğŸ¤– **AI Ä‘Ã£ tá»± Ä‘á»™ng lÆ°u giao dá»‹ch.**`, {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ“Š Xem thá»‘ng kÃª', callback_data: 'stats_today' },
                  { text: 'ğŸ“‹ Lá»‹ch sá»­', callback_data: 'history' }
                ],
                [
                  { text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }
                ]
              ]
            },
            parse_mode: 'Markdown'
          });
        } catch (error) {
          console.error('Error confirming expense:', error);
          await ctx.editMessageText('âŒ Lá»—i khi xÃ¡c nháº­n chi tiÃªu. Vui lÃ²ng thá»­ láº¡i!', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            }
          });
        }
        break;
        
      case 'income_stats':
        await ctx.editMessageText(`ğŸ’° **PhÃ¢n tÃ­ch Thu nháº­p**

ğŸ“Š **Chá»n loáº¡i phÃ¢n tÃ­ch:**`, {
          reply_markup: {
            inline_keyboard: [
              [
                { text: 'ğŸ“ˆ PhÃ¢n tÃ­ch hiá»‡u suáº¥t', callback_data: 'income_analysis' },
                { text: 'ğŸ“‹ Lá»‹ch sá»­ thu nháº­p', callback_data: 'income_history' }
              ],
              [
                { text: 'ğŸ¯ Má»¥c tiÃªu thu nháº­p', callback_data: 'income_goals' },
                { text: 'ğŸ¤– AI phÃ¢n loáº¡i', callback_data: 'income_ai' }
              ],
              [
                { text: 'ğŸ“… Thá»‘ng kÃª theo thá»i gian', callback_data: 'income_stats_time' },
                { text: 'ğŸ”™ Menu chÃ­nh', callback_data: 'main_menu' }
              ]
            ]
          },
          parse_mode: 'Markdown'
        });
        break;
        
      case 'income_analysis':
        try {
          const analysis = await incomeAnalysisService.analyzeIncomePerformance(userId, 'monthly');
          
          let message = `ğŸ“ˆ **PhÃ¢n tÃ­ch Thu nháº­p ThÃ¡ng nÃ y**\n\n`;
          message += `ğŸ’° **Tá»•ng thu nháº­p:** ${analysis.totalIncome.toLocaleString('vi-VN')}Ä‘\n`;
          message += `ğŸ“ **Sá»‘ giao dá»‹ch:** ${analysis.transactionCount}\n`;
          
          if (analysis.growthRate !== null) {
            const growthEmoji = analysis.growthRate > 0 ? 'ğŸš€' : analysis.growthRate < 0 ? 'âš ï¸' : 'ğŸ“Š';
            message += `${growthEmoji} **TÄƒng trÆ°á»Ÿng:** ${analysis.growthRate.toFixed(1)}% so vá»›i thÃ¡ng trÆ°á»›c\n\n`;
          }
          
          // PhÃ¢n tÃ­ch theo nguá»“n
          const sources = Object.entries(analysis.sourceBreakdown);
          if (sources.length > 0) {
            message += `ğŸ“‚ **PhÃ¢n bá»• theo nguá»“n:**\n`;
            sources.forEach(([source, data]) => {
              const percentage = ((data.amount / analysis.totalIncome) * 100).toFixed(1);
              message += `â€¢ ${incomeAnalysisService.getSourceText(source)}: ${data.amount.toLocaleString('vi-VN')}Ä‘ (${percentage}%)\n`;
            });
            message += `\n`;
          }
          
          // Insights
          if (analysis.insights) {
            message += `ğŸ’¡ **Nháº­n xÃ©t:**\n${analysis.insights}\n\n`;
          }
          
          // Recommendations
          if (analysis.recommendations) {
            message += `ğŸ¯ **Gá»£i Ã½:**\n${analysis.recommendations}`;
          }
          
          await ctx.editMessageText(message, {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ“… ThÃ¡ng nÃ y', callback_data: 'income_analysis_monthly' },
                  { text: 'ğŸ“… QuÃ½ nÃ y', callback_data: 'income_analysis_quarterly' },
                  { text: 'ğŸ“… NÄƒm nÃ y', callback_data: 'income_analysis_yearly' }
                ],
                [
                  { text: 'ğŸ“Š PhÃ¢n tÃ­ch khÃ¡c', callback_data: 'income_stats' },
                  { text: 'ğŸ”™ Menu chÃ­nh', callback_data: 'main_menu' }
                ]
              ]
            },
            parse_mode: 'Markdown'
          });
        } catch (error) {
          console.error('Error in income analysis:', error);
          await ctx.editMessageText('âŒ Lá»—i khi phÃ¢n tÃ­ch thu nháº­p. Vui lÃ²ng thá»­ láº¡i!', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ”™ Thu nháº­p', callback_data: 'income_stats' }],
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            }
          });
        }
        break;
        
      case 'income_analysis_monthly':
      case 'income_analysis_quarterly':
      case 'income_analysis_yearly':
        try {
          const period = callbackData.replace('income_analysis_', '');
          const analysis = await incomeAnalysisService.analyzeIncomePerformance(userId, period);
          
          let message = `ğŸ“ˆ **PhÃ¢n tÃ­ch Thu nháº­p ${getPeriodText(period)}**\n\n`;
          message += `ğŸ’° **Tá»•ng thu nháº­p:** ${analysis.totalIncome.toLocaleString('vi-VN')}Ä‘\n`;
          message += `ğŸ“ **Sá»‘ giao dá»‹ch:** ${analysis.transactionCount}\n`;
          
          if (analysis.growthRate !== null) {
            const growthEmoji = analysis.growthRate > 0 ? 'ğŸš€' : analysis.growthRate < 0 ? 'âš ï¸' : 'ğŸ“Š';
            message += `${growthEmoji} **TÄƒng trÆ°á»Ÿng:** ${analysis.growthRate.toFixed(1)}% so vá»›i ${getPeriodText(period)} trÆ°á»›c\n\n`;
          }
          
          // PhÃ¢n tÃ­ch theo nguá»“n
          const sources = Object.entries(analysis.sourceBreakdown);
          if (sources.length > 0) {
            message += `ğŸ“‚ **PhÃ¢n bá»• theo nguá»“n:**\n`;
            sources.forEach(([source, data]) => {
              const percentage = ((data.amount / analysis.totalIncome) * 100).toFixed(1);
              message += `â€¢ ${incomeAnalysisService.getSourceText(source)}: ${data.amount.toLocaleString('vi-VN')}Ä‘ (${percentage}%)\n`;
            });
            message += `\n`;
          }
          
          // Insights vÃ  recommendations
          if (analysis.insights) {
            message += `ğŸ’¡ **Nháº­n xÃ©t:**\n${analysis.insights}\n\n`;
          }
          
          if (analysis.recommendations) {
            message += `ğŸ¯ **Gá»£i Ã½:**\n${analysis.recommendations}`;
          }
          
          await ctx.editMessageText(message, {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ“… ThÃ¡ng nÃ y', callback_data: 'income_analysis_monthly' },
                  { text: 'ğŸ“… QuÃ½ nÃ y', callback_data: 'income_analysis_quarterly' },
                  { text: 'ğŸ“… NÄƒm nÃ y', callback_data: 'income_analysis_yearly' }
                ],
                [
                  { text: 'ğŸ“Š PhÃ¢n tÃ­ch khÃ¡c', callback_data: 'income_stats' },
                  { text: 'ğŸ”™ Menu chÃ­nh', callback_data: 'main_menu' }
                ]
              ]
            },
            parse_mode: 'Markdown'
          });
        } catch (error) {
          console.error('Error in income analysis:', error);
          await ctx.editMessageText('âŒ Lá»—i khi phÃ¢n tÃ­ch thu nháº­p. Vui lÃ²ng thá»­ láº¡i!', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ”™ Thu nháº­p', callback_data: 'income_stats' }],
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            }
          });
        }
        break;
        
      case 'income_history':
        try {
          const { PrismaClient } = require('@prisma/client');
          const prisma = new PrismaClient();
          
          const incomes = await prisma.income.findMany({
            where: { userId },
            orderBy: { createdAt: 'desc' },
            take: 10
          });
          
          let message = `ğŸ“‹ **Lá»‹ch sá»­ Thu nháº­p (10 gáº§n nháº¥t)**\n\n`;
          
          if (incomes.length === 0) {
            message += `ğŸ“ **ChÆ°a cÃ³ thu nháº­p nÃ o!**\n\n`;
            message += `ğŸ’¡ **CÃ¡ch thÃªm thu nháº­p:**\n`;
            message += `â€¢ Nháº­p: \`"LÆ°Æ¡ng thÃ¡ng 7 15000000"\`\n`;
            message += `â€¢ Nháº­p: \`"ThÆ°á»Ÿng dá»± Ã¡n 5000000"\`\n`;
            message += `â€¢ Nháº­p: \`"Freelance website 3000000"\``;
          } else {
            incomes.forEach((income, index) => {
              message += `${index + 1}. ğŸ’° **${income.amount.toLocaleString('vi-VN')}Ä‘**\n`;
              message += `   ğŸ“‚ ${incomeAnalysisService.getSourceText(income.source)}\n`;
              message += `   ğŸ“… ${formatDate(income.createdAt)}\n`;
              if (income.description) {
                message += `   ğŸ“ ${income.description}\n`;
              }
                             // TODO: Uncomment after migration
               // if (income.aiCategory && income.aiConfidence) {
               //   message += `   ğŸ¤– AI: ${incomeAnalysisService.getSourceText(income.aiCategory)} (${(income.aiConfidence * 100).toFixed(0)}%)\n`;
               // }
              message += `\n`;
            });
          }
          
          await ctx.editMessageText(message, {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ“Š PhÃ¢n tÃ­ch thu nháº­p', callback_data: 'income_analysis' },
                  { text: 'ğŸ¯ Má»¥c tiÃªu thu nháº­p', callback_data: 'income_goals' }
                ],
                [
                  { text: 'ğŸ”™ Thu nháº­p', callback_data: 'income_stats' },
                  { text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }
                ]
              ]
            },
            parse_mode: 'Markdown'
          });
        } catch (error) {
          console.error('Error getting income history:', error);
          await ctx.editMessageText('âŒ Lá»—i khi láº¥y lá»‹ch sá»­ thu nháº­p. Vui lÃ²ng thá»­ láº¡i!', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ”™ Thu nháº­p', callback_data: 'income_stats' }],
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            }
          });
        }
        break;
        
      case 'income_goals':
        try {
          const goals = await incomeAnalysisService.getIncomeGoals(userId);
          
          let message = `ğŸ¯ **Má»¥c tiÃªu Thu nháº­p**\n\n`;
          
          if (goals.length === 0) {
            message += `ğŸ“ **ChÆ°a cÃ³ má»¥c tiÃªu nÃ o!**\n\n`;
            message += `ğŸ’¡ **CÃ¡ch táº¡o má»¥c tiÃªu:**\n`;
            message += `â€¢ Nháº­p: \`"Má»¥c tiÃªu lÆ°Æ¡ng 50 triá»‡u nÄƒm 2024"\`\n`;
            message += `â€¢ Nháº­p: \`"Má»¥c tiÃªu freelance 10 triá»‡u thÃ¡ng"\`\n`;
            message += `â€¢ Nháº­p: \`"Má»¥c tiÃªu Ä‘áº§u tÆ° 20 triá»‡u quÃ½"\``;
          } else {
            for (const goal of goals) {
              const updatedGoal = await incomeAnalysisService.updateGoalProgress(userId, goal.id);
              
              message += `ğŸ¯ **${goal.name}**\n`;
              message += `ğŸ’° **Má»¥c tiÃªu:** ${goal.targetAmount.toLocaleString('vi-VN')}Ä‘\n`;
              message += `ğŸ“Š **Hiá»‡n táº¡i:** ${updatedGoal.currentAmount.toLocaleString('vi-VN')}Ä‘\n`;
              message += `ğŸ“ˆ **Tiáº¿n Ä‘á»™:** ${updatedGoal.progress.toFixed(1)}%\n`;
              message += `â° **Thá»i gian:** ${getPeriodText(goal.period)}\n`;
              message += `ğŸ“… **Tá»«:** ${formatDate(goal.startDate)}\n`;
              if (goal.endDate) {
                message += `ğŸ“… **Äáº¿n:** ${formatDate(goal.endDate)}\n`;
              }
              message += `\n`;
            }
          }
          
          await ctx.editMessageText(message, {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ“Š PhÃ¢n tÃ­ch thu nháº­p', callback_data: 'income_analysis' },
                  { text: 'ğŸ“‹ Lá»‹ch sá»­ thu nháº­p', callback_data: 'income_history' }
                ],
                [
                  { text: 'ğŸ”™ Thu nháº­p', callback_data: 'income_stats' },
                  { text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }
                ]
              ]
            },
            parse_mode: 'Markdown'
          });
        } catch (error) {
          console.error('Error getting income goals:', error);
          await ctx.editMessageText('âŒ Lá»—i khi láº¥y má»¥c tiÃªu thu nháº­p. Vui lÃ²ng thá»­ láº¡i!', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ”™ Thu nháº­p', callback_data: 'income_stats' }],
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            }
          });
        }
        break;
        
      case 'income_ai':
        try {
          const { PrismaClient } = require('@prisma/client');
          const prisma = new PrismaClient();
          
          const mappings = await prisma.aICategoryMapping.findMany({
            where: { userId },
            orderBy: { usageCount: 'desc' },
            take: 10
          });
          
          let message = `ğŸ¤– **AI PhÃ¢n loáº¡i Thu nháº­p**\n\n`;
          
          if (mappings.length === 0) {
            message += `ğŸ“ **ChÆ°a cÃ³ dá»¯ liá»‡u AI!**\n\n`;
            message += `ğŸ’¡ **CÃ¡ch sá»­ dá»¥ng:**\n`;
            message += `â€¢ ThÃªm thu nháº­p: \`"LÆ°Æ¡ng thÃ¡ng 7 15000000"\`\n`;
            message += `â€¢ AI sáº½ tá»± Ä‘á»™ng phÃ¢n loáº¡i vÃ  há»c tá»« mÃ´ táº£\n`;
            message += `â€¢ CÃ ng nhiá»u dá»¯ liá»‡u, AI cÃ ng chÃ­nh xÃ¡c`;
          } else {
            message += `ğŸ“Š **Top 10 tá»« khÃ³a Ä‘Æ°á»£c sá»­ dá»¥ng:**\n\n`;
            mappings.forEach((mapping, index) => {
              message += `${index + 1}. **${mapping.keyword}**\n`;
              message += `   ğŸ“‚ â†’ ${incomeAnalysisService.getSourceText(mapping.category)}\n`;
              message += `   ğŸ“Š Sá»­ dá»¥ng: ${mapping.usageCount} láº§n\n`;
              message += `   ğŸ¯ Äá»™ tin cáº­y: ${(mapping.confidence * 100).toFixed(0)}%\n\n`;
            });
          }
          
          await ctx.editMessageText(message, {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ“Š PhÃ¢n tÃ­ch thu nháº­p', callback_data: 'income_analysis' },
                  { text: 'ğŸ“‹ Lá»‹ch sá»­ thu nháº­p', callback_data: 'income_history' }
                ],
                [
                  { text: 'ğŸ”™ Thu nháº­p', callback_data: 'income_stats' },
                  { text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }
                ]
              ]
            },
            parse_mode: 'Markdown'
          });
        } catch (error) {
          console.error('Error getting AI mappings:', error);
          await ctx.editMessageText('âŒ Lá»—i khi láº¥y dá»¯ liá»‡u AI. Vui lÃ²ng thá»­ láº¡i!', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ”™ Thu nháº­p', callback_data: 'income_stats' }],
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            }
          });
        }
        break;
        
      case 'income_stats_time':
        await ctx.editMessageText(`ğŸ“… **Thá»‘ng kÃª Thu nháº­p theo Thá»i gian**

ğŸ“Š **Chá»n thá»i gian:**`, {
          reply_markup: {
            inline_keyboard: [
              [
                { text: 'ğŸ“… HÃ´m nay', callback_data: 'income_stats_today' },
                { text: 'ğŸ“… Tuáº§n nÃ y', callback_data: 'income_stats_week' }
              ],
              [
                { text: 'ğŸ“… ThÃ¡ng nÃ y', callback_data: 'income_stats_month' },
                { text: 'ğŸ“… NÄƒm nÃ y', callback_data: 'income_stats_year' }
              ],
              [
                { text: 'ğŸ”™ Thu nháº­p', callback_data: 'income_stats' },
                { text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }
              ]
            ]
          },
          parse_mode: 'Markdown'
        });
        break;
        
      case 'income_stats_today':
      case 'income_stats_week':
      case 'income_stats_month':
      case 'income_stats_year':
        try {
          const period = callbackData.replace('income_stats_', '');
          const analysis = await incomeAnalysisService.analyzeIncomePerformance(userId, period);
          
          let message = `ğŸ’° **Thu nháº­p ${getPeriodText(period)}**\n`;
          message += `ğŸ“… **${getCurrentDateText(period)}**\n\n`;
          message += `ğŸ’µ **Tá»•ng:** ${analysis.totalIncome.toLocaleString('vi-VN')}Ä‘\n`;
          message += `ğŸ“ **Giao dá»‹ch:** ${analysis.transactionCount}\n\n`;
          
          // PhÃ¢n tÃ­ch theo nguá»“n
          const sources = Object.entries(analysis.sourceBreakdown);
          if (sources.length > 0) {
            message += `ğŸ“‚ **PhÃ¢n bá»• theo nguá»“n:**\n`;
            sources.forEach(([source, data]) => {
              const percentage = ((data.amount / analysis.totalIncome) * 100).toFixed(1);
              message += `â€¢ ${incomeAnalysisService.getSourceText(source)}: ${data.amount.toLocaleString('vi-VN')}Ä‘ (${percentage}%)\n`;
            });
          }
          
          await ctx.editMessageText(message, {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ“Š PhÃ¢n tÃ­ch chi tiáº¿t', callback_data: 'income_analysis' },
                  { text: 'ğŸ“‹ Lá»‹ch sá»­ thu nháº­p', callback_data: 'income_history' }
                ],
                [
                  { text: 'ğŸ”™ Thá»‘ng kÃª thá»i gian', callback_data: 'income_stats_time' },
                  { text: 'ğŸ”™ Thu nháº­p', callback_data: 'income_stats' }
                ],
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            },
            parse_mode: 'Markdown'
          });
        } catch (error) {
          console.error('Error getting income stats:', error);
          await ctx.editMessageText('âŒ Lá»—i khi láº¥y thá»‘ng kÃª thu nháº­p. Vui lÃ²ng thá»­ láº¡i!', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ”™ Thu nháº­p', callback_data: 'income_stats' }],
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            }
          });
        }
        break;
        
      case 'balance':
        const balance = await financeService.getUserBalance(userId);
        let balanceMessage = `ğŸ’³ **TÃ i chÃ­nh**\n\n`;
        balanceMessage += `ğŸ’µ **Thu nháº­p:** ${balance.totalIncome.toLocaleString('vi-VN')}Ä‘\n`;
        balanceMessage += `ğŸ’¸ **Chi tiÃªu:** ${balance.totalExpense.toLocaleString('vi-VN')}Ä‘\n`;
        balanceMessage += `ğŸ’° **Sá»‘ dÆ°:** ${balance.totalBalance.toLocaleString('vi-VN')}Ä‘`;
        
        await ctx.editMessageText(balanceMessage, {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸº HÅ© tiá»n', callback_data: 'jars' }],
              [{ text: 'ğŸ”™ Menu chÃ­nh', callback_data: 'main_menu' }]
            ]
          },
          parse_mode: 'Markdown'
        });
        break;
        
      case 'jars':
        // Chuyá»ƒn Ä‘áº¿n callbackHandler Ä‘á»ƒ xá»­ lÃ½
        const jarCallbackHandled = await handleJarCallbacks(ctx);
        if (!jarCallbackHandled) {
          // Náº¿u khÃ´ng xá»­ lÃ½ Ä‘Æ°á»£c, hiá»ƒn thá»‹ bÃ¡o cÃ¡o máº·c Ä‘á»‹nh
          try {
            const report = await jarService.generateJarReport(userId);
            const keyboard = [
              [
                { text: 'â• Táº¡o hÅ© má»›i', callback_data: 'jar_create' },
                { text: 'ğŸ—‘ï¸ XÃ³a hÅ©', callback_data: 'jar_delete' }
              ],
              [
                { text: 'âœï¸ Cáº­p nháº­t hÅ©', callback_data: 'jar_update' },
                { text: 'ğŸ“Š BÃ¡o cÃ¡o hÅ©', callback_data: 'jar_report' }
              ],
              [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
            ];
            
            await ctx.editMessageText(report, {
              reply_markup: { inline_keyboard: keyboard },
              parse_mode: 'Markdown'
            });
          } catch (error) {
            console.error('Error generating jar report:', error);
            await ctx.editMessageText('âŒ **Lá»—i khi táº¡o bÃ¡o cÃ¡o hÅ© tiá»n**', {
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
                ]
              },
              parse_mode: 'Markdown'
            });
          }
        }
        break;
        
      case 'goals':
        try {
          const goalService = require('./services/goalService');
          const result = await goalService.generateGoalReport(userId);
          
          const keyboard = [
            [
              { text: 'ğŸ“Š Cáº­p nháº­t tiáº¿n Ä‘á»™', callback_data: 'goal_update_progress' },
              { text: 'â• Táº¡o má»¥c tiÃªu má»›i', callback_data: 'goal_create_new' }
            ],
            [
              { text: 'ğŸš¨ Cáº£nh bÃ¡o', callback_data: 'goal_warnings' },
              { text: 'ğŸ“‹ Xem chi tiáº¿t', callback_data: 'goal_details' }
            ],
            [
              { text: 'ğŸ¯ Táº¡o tá»« máº«u', callback_data: 'goal_template' },
              { text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }
            ]
          ];
          
          await ctx.editMessageText(result.message, {
            reply_markup: { inline_keyboard: keyboard },
            parse_mode: 'Markdown'
          });
        } catch (error) {
          console.error('Error generating goal report:', error);
          await ctx.editMessageText('âŒ **Lá»—i khi táº¡o bÃ¡o cÃ¡o má»¥c tiÃªu. Vui lÃ²ng thá»­ láº¡i!**', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            },
            parse_mode: 'Markdown'
          });
        }
        break;
        
      case 'goal_template':
        try {
          const goalHandler = require('./handlers/goalHandler');
          await goalHandler.handleCreateGoalsFromTemplate(ctx.message, ctx.telegram);
        } catch (error) {
          console.error('Error creating goals from template:', error);
          await ctx.editMessageText('âŒ **Lá»—i khi táº¡o má»¥c tiÃªu tá»« máº«u. Vui lÃ²ng thá»­ láº¡i!**', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            },
            parse_mode: 'Markdown'
          });
        }
        break;
        
      case 'goal_warnings':
        try {
          const goalHandler = require('./handlers/goalHandler');
          await goalHandler.handleGoalWarnings(ctx.message, ctx.telegram);
        } catch (error) {
          console.error('Error checking goal warnings:', error);
          await ctx.editMessageText('âŒ **Lá»—i khi kiá»ƒm tra cáº£nh bÃ¡o má»¥c tiÃªu. Vui lÃ²ng thá»­ láº¡i!**', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            },
            parse_mode: 'Markdown'
          });
        }
        break;
        
      case 'goal_integrated_report':
        try {
          const goalService = require('./services/goalService');
          const result = await goalService.generateIntegratedGoalReport(userId);
          
          const keyboard = [
            [
              { text: 'ğŸš¨ Cáº£nh bÃ¡o tÃ­ch há»£p', callback_data: 'goal_integrated_warnings' },
              { text: 'ğŸ“Š Cáº­p nháº­t tiáº¿n Ä‘á»™', callback_data: 'goal_update_progress' }
            ],
            [
              { text: 'â• Táº¡o má»¥c tiÃªu má»›i', callback_data: 'goal_create_new' },
              { text: 'ğŸ“‹ Xem chi tiáº¿t', callback_data: 'goal_details' }
            ],
            [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
          ];
          
          await ctx.editMessageText(result.message, {
            reply_markup: { inline_keyboard: keyboard },
            parse_mode: 'Markdown'
          });
        } catch (error) {
          console.error('Error generating integrated goal report:', error);
          await ctx.editMessageText('âŒ **Lá»—i khi táº¡o bÃ¡o cÃ¡o tÃ­ch há»£p. Vui lÃ²ng thá»­ láº¡i!**', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            },
            parse_mode: 'Markdown'
          });
        }
        break;
        
      case 'history':
        const history = await financeService.getTransactionHistory(userId, 5);
        let historyMessage = `ğŸ“‹ **Lá»‹ch sá»­ (5 gáº§n nháº¥t)**\n\n`;
        
        if (history.length === 0) {
          historyMessage += `ğŸ“ **ChÆ°a cÃ³ giao dá»‹ch!**`;
        } else {
          history.forEach((transaction, index) => {
            historyMessage += `${index + 1}. ${getTransactionEmoji(transaction.type)} `;
            historyMessage += `**${transaction.amount.toLocaleString('vi-VN')}Ä‘**\n`;
            historyMessage += `   ğŸ“‚ ${transaction.category || transaction.source || 'N/A'}\n`;
            historyMessage += `   ğŸ“… ${formatDate(transaction.date)}\n`;
            if (transaction.description) {
              historyMessage += `   ğŸ“ ${transaction.description}\n`;
            }
            historyMessage += `\n`;
          });
        }
        
        await ctx.editMessageText(historyMessage, {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸ”™ Menu chÃ­nh', callback_data: 'main_menu' }]
            ]
          },
          parse_mode: 'Markdown'
        });
        break;
        
      // HÅ© tiá»n callbacks
      case 'jar_report':
        try {
          const jarService = require('./services/jarService');
          const report = await jarService.generateJarReport(userId);
          
          const keyboard = [
            [
              { text: 'âš™ï¸ Quáº£n lÃ½ hÅ©', callback_data: 'jar_manage' },
              { text: 'ğŸ”„ Cáº­p nháº­t tá»· lá»‡', callback_data: 'jar_update_ratios' }
            ],
            [
              { text: 'ğŸ“ˆ Lá»‹ch sá»­ giao dá»‹ch', callback_data: 'jar_history' },
              { text: 'ğŸ”„ Chuyá»ƒn tiá»n', callback_data: 'jar_transfer' }
            ],
            [
              { text: 'âš ï¸ Cáº£nh bÃ¡o', callback_data: 'jar_warnings' },
              { text: 'ğŸ’¡ Tá»‘i Æ°u hÃ³a', callback_data: 'jar_optimize' }
            ],
            [
              { text: 'ğŸ—‘ï¸ XÃ³a hÅ©', callback_data: 'jar_delete' },
              { text: 'â• Táº¡o hÅ© má»›i', callback_data: 'jar_create' }
            ],
            [
              { text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }
            ]
          ];
          
          await ctx.editMessageText(report, {
            reply_markup: { inline_keyboard: keyboard },
            parse_mode: 'Markdown'
          });
        } catch (error) {
          console.error('Error generating jar report:', error);
          await ctx.editMessageText('âŒ **Lá»—i khi táº¡o bÃ¡o cÃ¡o hÅ© tiá»n. Vui lÃ²ng thá»­ láº¡i!**', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
              ]
            },
            parse_mode: 'Markdown'
          });
        }
        break;
        

        
      case 'open_app':
        await ctx.editMessageText(`ğŸ“± Open App

ğŸ”— Truy cáº­p á»©ng dá»¥ng web cá»§a báº¡n:
${process.env.WEB_APP_URL || 'https://your-expense-app.com'}

ğŸ’¡ Hoáº·c sá»­ dá»¥ng mini app trong Telegram`, {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸŒ Má»Ÿ Web App', url: process.env.WEB_APP_URL || 'https://your-expense-app.com' }],
              [{ text: 'ğŸ”™ Vá» menu chÃ­nh', callback_data: 'main_menu' }]
            ]
          }
        });
        break;
        
      case 'bank_setup':
        await ctx.editMessageText(`ğŸ¦ Thiáº¿t láº­p NgÃ¢n hÃ ng

ğŸ“§ Káº¿t ná»‘i email Ä‘á»ƒ nháº­n thÃ´ng bÃ¡o giao dá»‹ch tá»± Ä‘á»™ng tá»«:
â€¢ ğŸ›ï¸ VCB, TCB, TPBank, MBBank, ACB
â€¢ ğŸ¤– AI tá»± Ä‘á»™ng phÃ¢n loáº¡i chi tiÃªu
â€¢ âš¡ Thá»±c hiá»‡n ngay khi cÃ³ giao dá»‹ch

ğŸ“‹ HÆ°á»›ng dáº«n thiáº¿t láº­p:`, {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸ“– HÆ°á»›ng dáº«n chi tiáº¿t', callback_data: 'bank_help' }],
              [{ text: 'âš™ï¸ Báº¯t Ä‘áº§u thiáº¿t láº­p', callback_data: 'bank_start' }],
              [{ text: 'ğŸ”™ Vá» menu chÃ­nh', callback_data: 'main_menu' }]
            ]
          }
        });
        break;
        
      case 'bank_help':
        await ctx.editMessageText(`ğŸ“– HÆ°á»›ng dáº«n Thiáº¿t láº­p Email/Bank

ğŸ”§ **BÆ°á»›c 1:** Táº¡o App Password cho Gmail
â€¢ VÃ o Google Account Settings
â€¢ Báº­t 2-Factor Authentication  
â€¢ Táº¡o App Password cho "Mail"

ğŸ”§ **BÆ°á»›c 2:** Cáº¥u hÃ¬nh trong .env
\`\`\`
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-app-password
\`\`\`

ğŸ”§ **BÆ°á»›c 3:** Restart bot
\`npm restart\`

ğŸ¦ **NgÃ¢n hÃ ng há»— trá»£:**
â€¢ VCB, TCB, TPBank, MBBank, ACB

ğŸ’¡ Chi tiáº¿t: Xem file BANK_SETUP.md`, {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸ”™ Vá» thiáº¿t láº­p bank', callback_data: 'bank_setup' }],
              [{ text: 'ğŸ  Menu chÃ­nh', callback_data: 'main_menu' }]
            ]
          }
        });
        break;
        
      case 'bank_start':
        await ctx.editMessageText(`âš™ï¸ Báº¯t Ä‘áº§u Thiáº¿t láº­p

ğŸ”§ **BÆ°á»›c hiá»‡n táº¡i:**
${process.env.EMAIL_USER ? 'âœ… Email Ä‘Ã£ cáº¥u hÃ¬nh' : 'âŒ ChÆ°a cáº¥u hÃ¬nh email'}
${process.env.EMAIL_PASSWORD ? 'âœ… Password Ä‘Ã£ cáº¥u hÃ¬nh' : 'âŒ ChÆ°a cáº¥u hÃ¬nh password'}

ğŸ’¡ **Äá»ƒ hoÃ n táº¥t thiáº¿t láº­p:**
1. Cáº¥u hÃ¬nh EMAIL_USER vÃ  EMAIL_PASSWORD trong file .env
2. Restart bot vá»›i: \`npm restart\`
3. Sá»­ dá»¥ng /bank_transactions Ä‘á»ƒ kiá»ƒm tra`, {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸ“– Xem hÆ°á»›ng dáº«n', callback_data: 'bank_help' }],
              [{ text: 'ğŸ”™ Vá» menu chÃ­nh', callback_data: 'main_menu' }]
            ]
          }
        });
        break;
        
      case 'help':
        await ctx.editMessageText(`â“ **HÆ°á»›ng dáº«n**

ğŸ“ **Ghi chi tiÃªu:**
â€¢ "Ä‚n trÆ°a 80k"
â€¢ "Cafe 30000 vá»›i báº¡n"
â€¢ "XÄƒng xe 200k"

ğŸ’¬ Chat tÆ° váº¥n:
â€¢ "TÆ° váº¥n tiáº¿t kiá»‡m cho tÃ´i"
â€¢ "LÃ m sao giáº£m chi tiÃªu?"
â€¢ "Gá»£i Ã½ láº­p káº¿ hoáº¡ch tÃ i chÃ­nh"

ğŸ›ï¸ TÆ° váº¥n mua hÃ ng:
â€¢ "TÆ° váº¥n mua Ä‘iá»‡n thoáº¡i"
â€¢ "NÃªn mua laptop khÃ´ng?"
â€¢ "CÃ³ nÃªn mua quáº§n Ã¡o?"

ğŸ“Š Thá»‘ng kÃª chi tiÃªu:
â€¢ /stats_menu - Menu thá»‘ng kÃª
â€¢ /stats_today - HÃ´m nay
â€¢ /stats_week - Tuáº§n nÃ y
â€¢ /stats_month - ThÃ¡ng nÃ y
â€¢ /stats_year - NÄƒm nÃ y

ğŸ’° Quáº£n lÃ½ tÃ i chÃ­nh:
â€¢ /balance - Sá»‘ dÆ° hiá»‡n táº¡i
â€¢ /add_income - ThÃªm thu nháº­p
â€¢ /income_stats - Thá»‘ng kÃª thu nháº­p
â€¢ /jars - Quáº£n lÃ½ hÅ© tiá»n
â€¢ /history - Lá»‹ch sá»­ giao dá»‹ch

ğŸ¦ TÃ­ch há»£p ngÃ¢n hÃ ng:
â€¢ /bank_help - HÆ°á»›ng dáº«n
â€¢ /bank_start - Thiáº¿t láº­p
â€¢ /bank_transactions - Xem giao dá»‹ch`);

// Register all finance commands
[
  'stats_today', 'stats_week', 'stats_month', 'stats_year', 'stats_menu', 'stats_custom',
  'add_income', 'income_stats', 'balance', 'setup_jars', 'jars', 'jar_deposit', 'jar_withdraw',
  'history', 'history_income', 'history_expense', 'history_jar',
  'bank_help', 'bank_start', 'bank_transactions',
  'muctieu', 'taomuctieu', 'capnhatmuctieu', 'muctieutemplate',
  'language'
].forEach(command => {
  bot.command(command, async (ctx) => {
    const args = ctx.message.text.split(' ').slice(1);
    await handleFinanceCommands(ctx, `/${command}`, args);
  });
});

// Stats command (legacy compatibility)
bot.command('stats', async (ctx) => {
  try {
    const userId = String(ctx.from.id);
    const stats = await expenseService.getTotalExpensesByUser(userId);
    
    ctx.reply(`ğŸ“Š Thá»‘ng kÃª chi tiÃªu cá»§a báº¡n:

ğŸ’° Tá»•ng chi tiÃªu: ${stats.total.toLocaleString()}Ä‘
ğŸ“ Sá»‘ giao dá»‹ch: ${stats.count}
ğŸ“… Táº¥t cáº£ thá»i gian

ğŸ¦ Sá»­ dá»¥ng /bank_help Ä‘á»ƒ tá»± Ä‘á»™ng hÃ³a chi tiÃªu!`);
  } catch (error) {
    ctx.reply('âŒ Lá»—i khi láº¥y thá»‘ng kÃª.');
  }
});

// Start bank monitoring if email is configured
async function initializeBankService() {
  if (process.env.EMAIL_USER && process.env.EMAIL_PASSWORD) {
    try {
      console.log('ğŸ¦ Initializing bank email monitoring...');
      await bankService.connect();
      bankService.startMonitoring();
    } catch (error) {
      console.error('âŒ Failed to initialize bank service:', error.message);
      console.log('ğŸ’¡ Configure email settings in .env to enable bank monitoring');
    }
  } else {
    console.log('ğŸ“§ Email not configured - bank monitoring disabled');
  }
}

// Launch bot
bot.launch({
  polling: {
    timeout: 10,
    limit: 100
  }
}).then(async () => {
  console.log("ğŸ¤– Bot Ä‘ang hoáº¡t Ä‘á»™ng thÃ nh cÃ´ng!");
  
  // Initialize bank service after bot starts
  await initializeBankService();
}).catch((error) => {
  console.error("âŒ Lá»—i khá»Ÿi Ä‘á»™ng bot:", error);
  
  if (error.response?.error_code === 404) {
    console.error("ğŸ”‘ Lá»—i 404: Bot token khÃ´ng há»£p lá»‡!");
    console.error("ğŸ“ HÃ£y kiá»ƒm tra BOT_TOKEN trong file .env");
    console.error("ğŸ”„ Hoáº·c táº¡o bot má»›i vá»›i @BotFather");
  }
  
  if (error.response?.error_code === 409) {
    console.error("âš ï¸ Lá»—i 409: Bot Ä‘ang cháº¡y á»Ÿ nÆ¡i khÃ¡c hoáº·c webhook Ä‘ang active");
    console.error("ğŸ”„ HÃ£y dá»«ng bot khÃ¡c hoáº·c xÃ³a webhook");
  }
});

// Graceful shutdown
process.once('SIGINT', () => {
  console.log('ğŸ›‘ Äang dá»«ng bot...');
  bankService.stopMonitoring();
  bot.stop('SIGINT');
});

process.once('SIGTERM', () => {
  console.log('ğŸ›‘ Äang dá»«ng bot...');
  bankService.stopMonitoring();
  bot.stop('SIGTERM');
});

// Helper functions
function getPeriodText(period) {
  switch (period) {
    case 'today': return 'hÃ´m nay';
    case 'week': return 'tuáº§n nÃ y';
    case 'month': return 'thÃ¡ng nÃ y';
    case 'year': return 'nÄƒm nÃ y';
    default: return period;
  }
}

function getCurrentDateText(period) {
  const now = new Date();
  
  switch (period) {
    case 'today':
      return now.toLocaleDateString('vi-VN', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    case 'week':
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - now.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      return `${weekStart.toLocaleDateString('vi-VN')} - ${weekEnd.toLocaleDateString('vi-VN')}`;
    case 'month':
      return now.toLocaleDateString('vi-VN', { 
        year: 'numeric', 
        month: 'long' 
      });
    case 'year':
      return now.getFullYear().toString();
    default:
      return now.toLocaleDateString('vi-VN');
  }
}

function getPriorityText(priority) {
  switch (priority) {
    case 'high': return 'ğŸŸ¢ Cao (CÃ³ thá»ƒ mua)';
    case 'medium': return 'ğŸŸ¡ Trung bÃ¬nh (CÃ¢n nháº¯c)';
    case 'low': return 'ğŸ”´ Tháº¥p (NÃªn hoÃ£n)';
    default: return priority;
  }
}

function getSourceText(source) {
  const sourceMap = {
    'salary': 'LÆ°Æ¡ng',
    'bonus': 'ThÆ°á»Ÿng',
    'freelance': 'Freelance',
    'investment': 'Äáº§u tÆ°',
    'other': 'KhÃ¡c'
  };
  return sourceMap[source] || source;
}

function getJarEmoji(jarName) {
  const jarEmojiMap = {
    'Necessities': 'ğŸ ',
    'Education': 'ğŸ“š',
    'Entertainment': 'ğŸ®',
    'Emergency': 'ğŸš¨',
    'Investment': 'ğŸ“ˆ',
    'Charity': 'â¤ï¸'
  };
  return jarEmojiMap[jarName] || 'ğŸº';
}

function getTransactionEmoji(type) {
  const typeEmojiMap = {
    'income': 'ğŸ’µ',
    'expense': 'ğŸ’¸',
    'jar_deposit': 'ğŸºâ¬†ï¸',
    'jar_withdraw': 'ğŸºâ¬‡ï¸'
  };
  return typeEmojiMap[type] || 'ğŸ’°';
}

function formatDate(date) {
  return new Date(date).toLocaleDateString('vi-VN', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Traditional command handlers for backward compatibility
bot.help((ctx) => {
  const helpMessage = `ğŸ¤– Bot quáº£n lÃ½ chi tiÃªu thÃ´ng minh

ğŸ“ Ghi chi tiÃªu:
â€¢ "Ä‚n trÆ°a 80k"
â€¢ "Cafe 30000 vá»›i báº¡n"
â€¢ "XÄƒng xe 200k"

ğŸ’¬ Chat tÆ° váº¥n:
â€¢ "TÆ° váº¥n tiáº¿t kiá»‡m cho tÃ´i"
â€¢ "LÃ m sao giáº£m chi tiÃªu?"
â€¢ "Gá»£i Ã½ láº­p káº¿ hoáº¡ch tÃ i chÃ­nh"

ğŸ›ï¸ TÆ° váº¥n mua hÃ ng:
â€¢ "TÆ° váº¥n mua Ä‘iá»‡n thoáº¡i"
â€¢ "NÃªn mua laptop khÃ´ng?"
â€¢ "CÃ³ nÃªn mua quáº§n Ã¡o?"

ğŸ“Š Thá»‘ng kÃª chi tiÃªu:
â€¢ /stats_menu - Menu thá»‘ng kÃª
â€¢ /stats_today - HÃ´m nay
â€¢ /stats_week - Tuáº§n nÃ y
â€¢ /stats_month - ThÃ¡ng nÃ y
â€¢ /stats_year - NÄƒm nÃ y

ğŸ’° Quáº£n lÃ½ tÃ i chÃ­nh:
â€¢ /balance - Sá»‘ dÆ° hiá»‡n táº¡i
â€¢ /add_income - ThÃªm thu nháº­p
â€¢ /income_stats - Thá»‘ng kÃª thu nháº­p
â€¢ /jars - Quáº£n lÃ½ hÅ© tiá»n
â€¢ /history - Lá»‹ch sá»­ giao dá»‹ch

ğŸ¦ TÃ­ch há»£p ngÃ¢n hÃ ng:
â€¢ /bank_help - HÆ°á»›ng dáº«n
â€¢ /bank_start - Thiáº¿t láº­p
â€¢ /bank_transactions - Xem giao dá»‹ch

ğŸŒ NgÃ´n ngá»¯:
â€¢ /language - Thay Ä‘á»•i ngÃ´n ngá»¯`;

  return ctx.reply(helpMessage, {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ”™ Menu chÃ­nh', callback_data: 'main_menu' }]
      ]
    }
  });
});

// Export bot for testing
module.exports = bot;
